global lamda;
global U;
global v;
global N_mode;

N_mode=5;

load discrete_1134.mat;
for k=1:length(U)
    U{k}=[U{k},ones(size(U{k},1),1)];
end

max_ite=2;
%for N_mode=4;
%x0=[-0.0152124405814063,-0.0668844817172746,-0.0915404415499302,1.81924371122312,-0.0114733332701764,-0.0506836440450139,-0.299279180833732,-0.567558679968260,0.153609668271140,0.301974694064741,0.243081953533247,-4.13330619383683,0.439605150094851,-0.00806681706885363,-0.0701891732244912,-8.93420899059479,0.00259873649092216,-0.0267813014036974,0.0983138417239101,0.282561744563470,-0.0298028589610205,-0.0471030703518374,-0.0128591930241386,1.91996396985194,-0.0357730727655771,-0.123926687654248,-0.341510557175843,0.388152011670245,-0.0872704967581212,-0.0683339469937766,-0.141929989021909,-2.36360447721870,0.207192221731181,0.409351906906585,-0.168702490893626,-4.86551520061426,0.0979722855716476,0.0259454791250097,0.105934928960483,-1.12653989175280,0.0309640855326023,-0.0121151962538150,-0.0305066427844595,1.49894690089596,-0.0416345634182415,-0.00424839140332443,-0.106734067365316,0.771747404787973,-0.0699760378337998,0.536141977116890,-0.118889049356025,-3.22794955210747,0.159493179707997,0.279855544887512,0.142512167906003,-4.13373588183419,0.119779543602729,0.0988600090427923,0.203673882478037,-2.36518014588972,0.0462582494707195,0.000524616868939503,0.0915543952089887,1.16282641540540,-0.0245824930268355,-0.0547446859639619,-0.00743118178362176,0.515103897951643,0.000932277597054952,-0.0317524994573818,-0.00567370461257113,1.10965111546823,0.00743341800060987,-0.0408177827580288,0.00750356047173606,1.76297226643226,0.0311370155940223,-0.0501817171290778,0.102008402870270,2.52102401928795,0.0603504990140757,0.0173756171203219,-0.0363806382147703,-2.17605463738738,-0.00135470464303596,0.0314702648531528,0.00416964897855077,-2.79014425076526,0.0174171370734275,-0.0100095857317335,0.0845519163391547,-2.85170929932331,0.111660115955450,0.0675592414804808,0.129887785621446,-2.62270071273251,1.50891956467103,0.390476190476191,0.376190476190476,0.133333333333333,0.100000000000000];
%for N_mode=5;
%x0=[0.00928414961092869,0.0123853015390717,0.126074529397528,2.22111156047361,-0.0185174644153753,-0.0236734454293288,0.202531600211892,-0.771324959452521,-0.00634020280727906,0.196837267078393,0.0465860966022113,-2.85564666866911,0.154111701399943,-0.0227091189997172,0.104525346167917,-11.2055155226816,0.0609589673350861,0.102488182472071,0.104891985308125,-5.45833841049764,-0.0261009208413375,-0.0258936804345186,-0.156320644169522,0.731466445673492,0.00170343157286272,0.0187852798190039,0.0402788201154463,2.00639860172776,0.00474582464356293,-0.0101514530918274,0.0944042835003155,-0.420414799596175,0.0141741926151107,-0.0901359115887448,-0.419889036604099,-7.91469250056141,-0.536926112159649,0.149954325411197,1.52265571679857,-7.76774565691319,-0.178921967826203,0.394076385303650,-0.331330170208805,-0.933572345443987,0.0327642188877054,-0.0282408051071906,-0.109532897728112,-0.632027341361744,-0.00342581139804380,-0.00404336393497199,0.00110296030040853,2.15623745360690,-0.0143505841519491,0.0255305016411087,0.250915901996257,0.588773022133154,0.0306853232845702,-0.00487014079097566,0.162384214468924,-2.66235035763849,0.103224775867353,-0.0164338272712534,0.192020836341245,-7.15143643767226,-0.0368041694099835,0.0584132056694416,0.0808494609042824,-2.52561927940324,0.0590350485461102,-0.0112972397798770,-0.0664315031790520,-1.56462283507252,0.0121051892092842,-0.00425585363304597,-0.00417943596886726,1.77161056220221,0.00653822762004995,0.0177683172737505,0.0481917640297227,0.315002102141503,0.122612851890454,0.00812741490245049,0.280862555348057,-5.63658049696108,-0.0230016617912227,-0.0835848277313786,0.0438833475009670,-12.6987966299586,-0.0546882603401064,0.327155777456193,0.527081669359280,-3.65868020483537,0.0687258240624078,-0.0268257721744522,-0.0980116635824158,-2.25303357021668,0.0695146721174320,-0.0349004460521376,-0.100576259317978,0.832978778501911,-0.0105487208428560,-0.0229044822435473,-0.0305263105095070,0.534262363179254,0.00424422480581773,-0.0132567083920997,0.0111675210024667,1.10943858197147,0.0101676540880539,-0.0264195662278267,0.0205299374946831,1.79459727340342,0.00772700967860044,-0.0180040515089611,0.00718099495084940,2.99266854163666,0.0368238843458721,-0.0350323804122414,0.0400027814666552,3.53437520848977,0.0463462479017507,0.0305574884347639,0.158019094309622,-2.77671534702817,0.00224841019748510,-0.00341410300635608,0.0245205934636454,-3.01952265372345,0.0129233975190919,-0.0185027476735488,0.0130956375623709,-2.64342642754006,0.00481859799611919,0.0155332384314063,-0.0388462717799664,-2.25531719909664,0.0291337153508724,0.00237814924273712,0.0756390080513480,-1.15716716748412,1.45823675473085,0.0873015873015873,0.246913580246914,0.494708994708995,0.127865961199295,0.0432098765432099];
%for N_mode=3
%x0=[0.00199560321613923,0.199708076378056,0.176074093079764,2.03065721201532,0.707144349808720,0.756922579766364,2.32395410962083,-9.35939821399145,-0.0124297300634669,-0.0884446221948119,0.0951120865356804,-2.42343062234674,-4.51772264420117,-7.34002554647420,-4.10631472069577,-19.4970770629471,-0.653327788894778,-2.46866735029338,-3.71138031756560,-53.0936689677187,-0.267143324724653,-2.65767035593886,1.61029782079229,-82.2435895963145,0.0363681400648505,0.204448966001595,-0.0189198729297755,-1.15460449708451,0.682919805085430,2.52676920232216,3.38152389852336,54.2635286053279,0.0332510944112607,-0.105096060795623,-0.125638155595947,2.69889503967150,-0.00574092930037375,-0.0879657417175681,-0.0240655780639791,0.142054144712831,-0.0387094487792541,-0.0163040632121800,-0.487137295614936,0.956982240861283,0.0675407738898373,-0.130851151039978,0.0555183381742806,0.642563372714587,0.0263928800191679,0.0115858454245240,0.0257505068930062,-0.974334242667244,-0.112077549473130,0.0928208318170423,-2.43056547280294,0.149171656967561,0.0516698046541452,-0.000258245097772751,0.0566675571482008,-1.14693083843477,1.37764701205211,0.0114638447971781,0,0.988536155202822];

x0=zeros(1,4*N_mode^2+2*4*N_mode+1+N_mode);
x0(4*N_mode^2+4)=0.4;
x0(4*N_mode^2+8)=1;
x0(4*N_mode^2+12)=2;
x0(4*N_mode^2+16)=3.5;
x0(4*N_mode^2+20)=5;     %here are the mean
x0(4*N_mode^2+2*4*N_mode+1)=2;     % this is the beta?
x0(4*N_mode^2+2*4*N_mode+2:end)=1/N_mode*ones(1,N_mode);  %these are the initial distribution of the markov chain
%  

x=x0;   %here x0 is the initial guess for x, may be estimated from data
options = optimoptions('fminunc','Display','iter','Algorithm','trust-region','SpecifyObjectiveGradient',true,'StepTolerance',0.01);
% 
for k=1:max_ite
    k   %show the number of iteration
    x_initial=x;
lamda=DP_HMM(x);
[x,fval,exitflag,output]=fminunc(@loglikelihood,x(1:4*(N_mode^2+2*N_mode)+1),options);  %now x is a 1*61 vector, have to count for the initial state

temp=zeros(1,N_mode);
for m=1:length(lamda)
    temp(lamda{m}(1))=temp(lamda{m}(1))+1;
end
temp=temp/sum(temp);
x=[x,temp];
    
if max(abs(x-x_initial))<=10^-4
    break;
end

end



%next, generate pseudo time series of pedestrian, use all the three control
%input, this should be modified later
x_f=x;

for ll=1:length(U)
    
ini_prob=x(end-N_mode+1:end);
cum_prob(1)=ini_prob(1);
for k=2:N_mode
    cum_prob(k)=cum_prob(k-1)+ini_prob(k);
end
lam(1)=1+sum(cum_prob<rand(1));   %sample from the initial distribution

for i=1:N_mode
    for j=1:N_mode
        w{i,j}=x_f(1,N_mode*4*i+4*j-4*N_mode-3:4*N_mode*i+4*j-4*N_mode);
    end
end
beta=x_f(4*(N_mode^2+2*N_mode)+1);
for i=1:N_mode
    w_miu(i,1:4)=x_f(1,4*i+4*N_mode^2-3:4*i+4*N_mode^2);
    w_sigma(i,1:4)=x_f(1,4*i+4*N_mode^2+4*N_mode-3:4*i+4*N_mode^2+4*N_mode);
end

miu0=w_miu(lam(1),:)*U{ll}(1,:).';
sigma0=exp(w_sigma(lam(1),:)*U{ll}(1,:).');

vel{ll}(1)=randn(1)*sqrt(sigma0)+miu0;



% for k=2:length(v{ll})
%     
%     for i=1:N_mode
%     a(i,1)=w{i,lam(k-1)}*U{ll}(k,:).';
%     end
%     tran_matrix=softmax(a);
%     cum_matrix(1)=tran_matrix(1);
%     for i=2:N_mode
%     cum_matrix(i)=cum_matrix(i-1)+tran_matrix(i);
%     end
%     lam(k)=1+sum(cum_matrix<rand(1));
%     
%     miuk=w_miu(lam(k),:)*U{ll}(k,:).';
%     sigmak=exp(w_sigma(lam(k),:)*U{ll}(k,:).');
%     
%     desire_vel=randn(1)*sqrt(sigmak)+miuk;
%     
%     vel{ll}(k)=vel{ll}(k-1)+1/beta*(desire_vel-vel{ll}(k-1));
% end
% vel{ll}=vel{ll}.';

p_step=1;

for k=2:length(v{ll})
    
    if k<=p_step+2
        
    for i=1:N_mode
    a(i,1)=w{i,lam(k-1)}*U{ll}(1,:).';
    end
    
    else
        
    for i=1:N_mode
    a(i,1)=w{i,lam(k-1)}*U{ll}(k-p_step-1,:).';
    end
    
    end
    
    tran_matrix=softmax(a);
    cum_matrix(1)=tran_matrix(1);
    for i=2:N_mode
    cum_matrix(i)=cum_matrix(i-1)+tran_matrix(i);
    end
    lam(k)=1+sum(cum_matrix<rand(1));
    
    if k<=p_step+2
    miuk=w_miu(lam(k),:)*U{ll}(1,:).';
    sigmak=exp(w_sigma(lam(k),:)*U{ll}(1,:).');
    else
    miuk=w_miu(lam(k),:)*U{ll}(k-p_step-1,:).';
    sigmak=exp(w_sigma(lam(k),:)*U{ll}(k-p_step-1,:).');    
    end
    
    desire_vel=randn(1)*sqrt(sigmak)+miuk;
    
    vel{ll}(k)=vel{ll}(k-1)+1/beta*(desire_vel-vel{ll}(k-1));
end
vel{ll}=vel{ll}.';

end

    
    
    